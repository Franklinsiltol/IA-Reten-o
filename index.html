<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroAssist - Assistente Inteligente (v3.6 - Perguntas Vagas)</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1-H-um4lnsC7fmbqtHNgX38eK8270SYOE">
    <!-- Dependências -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3"></script>
    <script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* O CSS da v3.4 permanece o mesmo - moderno e branco */
        :root {
            --background-main: #FFFFFF; --background-secondary: #F0F2F5; --text-primary: #111B21;
            --text-secondary: #667781; --border-color: #E9EDEF; --primary: #007BFF;
            --accent: #00A884; --white: #FFFFFF; --black: #000000; --error: #d93025;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-secondary); color: var(--text-primary); line-height: 1.6; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
        .app-container { display: flex; flex-direction: column; max-width: 800px; width: 100%; height: 95vh; max-height: 900px; overflow: hidden; background-color: var(--background-main); border-radius: 24px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07); border: 1px solid var(--border-color); }
        header { background-color: var(--background-main); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 36px; height: 36px; border-radius: 50%; padding: 0; object-fit: cover; }
        .logo-text { font-weight: 600; font-size: 1.25rem; color: var(--text-primary); }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent); }
        .status-dot.loading { background-color: #FF9800; animation: pulse 1.5s infinite; }
        .status-dot.error { background-color: var(--error); }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--background-main); }
        .chat-area { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        .message { max-width: 75%; padding: 0.75rem 1.25rem; border-radius: 20px; line-height: 1.5; position: relative; animation: fadeIn 0.4s ease-out; word-wrap: break-word; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background-color: var(--primary); color: var(--white); margin-left: auto; border-bottom-right-radius: 5px; }
        .bot-message { background-color: var(--background-secondary); color: var(--text-primary); margin-right: auto; border-bottom-left-radius: 5px; }
        .message a { color: var(--primary); font-weight: 500; }
        .message-time { display: none; }
        .input-area-wrapper { background-color: var(--background-secondary); padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .input-area { display: flex; align-items: center; gap: 0.75rem; }
        #questionInput { flex: 1; padding: 0.8rem 1.5rem; border-radius: 999px; border: 1px solid var(--border-color); background-color: var(--background-main); color: var(--text-primary); font-family: 'Inter', sans-serif; font-size: 1rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #questionInput:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
        #questionInput::placeholder { color: var(--text-secondary); }
        .button { border: none; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        #askButton { background-color: var(--primary); color: var(--white); width: 48px; height: 48px; flex-shrink: 0; }
        #askButton:hover { transform: scale(1.08); background-color: #0069d9; }
        #askButton:active { transform: scale(1); }
        #suggestButton { background-color: transparent; color: var(--text-secondary); width: 48px; height: 48px; flex-shrink: 0; }
        #suggestButton:hover { background-color: var(--border-color); }
        .typing-indicator { display: flex; align-items: center; gap: 0.35rem; padding: 0.8rem 1.25rem; background-color: var(--background-secondary); border-radius: 20px; margin-right: auto; border-bottom-left-radius: 5px; width: fit-content; }
        .typing-dot { width: 8px; height: 8px; background-color: var(--text-secondary); border-radius: 50%; opacity: 0.4; animation: typingAnimation 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: 0s; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnimation { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-5px); opacity: 1; } }
        .settings-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer; color: var(--text-secondary);}
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--accent); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        .option-button, .action-button { display: inline-block; width: auto; padding: 0.5rem 1rem; margin: 0.5rem 0.5rem 0.5rem 0; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.9rem; text-align: center; cursor: pointer; transition: all 0.2s; border: none; }
        .option-button { background-color: var(--white); border: 1px solid var(--primary); color: var(--primary); width: 100%; font-size: 1rem; text-align: left; }
        .option-button:hover { background-color: var(--primary); color: var(--white); transform: translateY(-1px); }
        .action-button.yes { background-color: var(--accent); color: var(--white); }
        .action-button.no { background-color: var(--border-color); color: var(--text-secondary); }
        .action-button:hover { opacity: 0.9; transform: translateY(-1px); }
        .status-footer { padding-top: 0.75rem; text-align: right; font-size: 0.75rem; color: var(--text-secondary); }
        .model-loading-progress { padding-bottom: 0.5rem; }
        .progress-container { width: 100%; background-color: var(--border-color); border-radius: 99px; overflow: hidden; height: 6px; }
        .progress-bar { height: 100%; background-color: var(--primary); transition: width 0.3s ease; border-radius: 99px; }
        .model-status { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .custom-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 1rem; }
        .custom-modal-content { background-color: var(--background-main); padding: 2rem; border-radius: 16px; width: 100%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; }
        .custom-modal h3 { margin-bottom: 0.5rem; color: var(--text-primary); }
        .custom-modal p { margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.5; }
        #suggestionTextarea { width: 100%; min-height: 100px; border-radius: 8px; border: 1px solid var(--border-color); padding: 0.75rem; font-family: 'Inter', sans-serif; font-size: 1rem; resize: vertical; margin-bottom: 1.5rem; }
        #suggestionTextarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }
        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { height: 100vh; max-height: none; border-radius: 0; border: none; }
            .chat-area { padding: 1rem; }
            .input-area-wrapper { padding: 0.75rem 1rem; }
            .message { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div id="updateBanner" class="update-banner" style="display: none;">Nova atualização disponível! <a href="#" id="refreshLink">Recarregar agora</a></div>
    <div class="app-container"><header><div class="logo"><img src="https://lh3.googleusercontent.com/d/1tG7oc1T5Xd3f1vZ267xPCX9k2SVrfNz1" alt="Logo" class="logo-icon"><div class="logo-text">NeuroAssist</div></div><div class="settings-toggle"><label class="toggle-switch"><input type="checkbox" id="advancedModeToggle"><span class="toggle-slider"></span></label><span>Avançado</span></div><div class="status-indicator"><div class="status-dot loading"></div><span id="statusText">Conectando...</span></div></header><div class="chat-container"><div class="chat-area" id="chatArea"></div><div class="input-area-wrapper"><div id="modelLoadingProgress" class="model-loading-progress" style="display: none;"><div class="model-status"><span id="modelStatusText">Carregando modelo...</span><span id="modelProgressText">0%</span></div><div class="progress-container"><div id="modelProgressBar" class="progress-bar" style="width: 0%"></div></div></div><div class="input-area"><input type="text" id="questionInput" placeholder="Digite sua mensagem..." autocomplete="off"><button id="suggestButton" class="button" title="Sugerir uma pergunta"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><button id="askButton" class="button" title="Enviar"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div><div id="autoUpdateStatus" class="status-footer"></div></div></div></div>
    <div id="customSuggestionModal" class="custom-modal"><div class="custom-modal-content"><h3>Sugerir uma pergunta</h3><p>Não encontrou o que procurava? Ajude-nos a melhorar! Envie sua pergunta e ela será analisada por nossa equipe para ser adicionada à base de conhecimento.</p><textarea id="suggestionTextarea" placeholder="Escreva aqui a pergunta que você não encontrou..."></textarea><div class="modal-actions"><button id="cancelSuggestionBtn" class="action-button no">Cancelar</button><button id="submitSuggestionBtn" class="action-button yes">Enviar sugestão</button></div></div></div>

    <script>
        class NeuroAssist {
            constructor() {
                this.config = {
                    SHEET_ID: "1pgoYg76gutqLnOlsk3mN40HfzN9n-x_6oJQcfkZEBzY", SHEET_NAME: "Retenção", AUTO_UPDATE_INTERVAL: 600000, DB_NAME: "NeuroAssistDB", STORE_NAME: "KnowledgeBase", DATA_KEY: "qaData", LAST_UPDATE_KEY: "lastUpdate", MODEL_KEY: "useModel", SIMILARITY_THRESHOLD: 0.7, FUSE_THRESHOLD: 0.35,
                    // --- NOVA LISTA DE FRASES VAGAS ---
                    VAGUE_PHRASES: ['como funciona', 'o que é', 'qual o processo', 'qual o procedimento', 'como fazer para']
                };
                this.elements = { questionInput: document.getElementById('questionInput'), askButton: document.getElementById('askButton'), suggestButton: document.getElementById('suggestButton'), chatArea: document.getElementById('chatArea'), statusText: document.getElementById('statusText'), statusDot: document.querySelector('.status-dot'), autoUpdateStatus: document.getElementById('autoUpdateStatus'), updateBanner: document.getElementById('updateBanner'), refreshLink: document.getElementById('refreshLink'), modelLoadingProgress: document.getElementById('modelLoadingProgress'), modelStatusText: document.getElementById('modelStatusText'), modelProgressText: document.getElementById('modelProgressText'), modelProgressBar: document.getElementById('modelProgressBar'), advancedModeToggle: document.getElementById('advancedModeToggle'), customSuggestionModal: document.getElementById('customSuggestionModal'), suggestionTextarea: document.getElementById('suggestionTextarea'), submitSuggestionBtn: document.getElementById('submitSuggestionBtn'), cancelSuggestionBtn: document.getElementById('cancelSuggestionBtn') };
                this.state = { db: null, fuse: null, qaData: [], lastUpdateHash: "", autoUpdateIntervalId: null, useModel: null, isModelLoaded: false, isModelLoading: false, isAdvancedMode: false, conversationHistory: [], lastUnansweredQuestion: null, isAwaitingSuggestion: false };
                this._init();
            }
            async _init() {
                try {
                    await this._initDatabase(); await this._loadInitialData(); this._setupEventListeners();
                    this._startAutoUpdate(); await this._checkAdvancedModeStatus();
                } catch (error) { console.error("Falha na inicialização crítica:", error); this._updateStatus("Erro crítico", 'error'); }
            }
            async _initDatabase() { return new Promise((resolve, reject) => { const request = indexedDB.open(this.config.DB_NAME, 3); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(this.config.STORE_NAME)) { db.createObjectStore(this.config.STORE_NAME); } }; request.onsuccess = (e) => { this.state.db = e.target.result; resolve(); }; request.onerror = (e) => { console.error("Erro no IndexedDB:", e.target.error); reject(e.target.error); }; }); }
            async _loadInitialData() {
                try {
                    const { data, hash } = await this._loadFromDatabase();
                    if (data && data.length > 0) {
                        this.state.qaData = data; this.state.lastUpdateHash = hash; this._initSearchEngine();
                        this._updateStatus(`Pronto`); this._addBotMessage("Olá! Sou o NeuroAssist. Como posso ajudar?");
                    } else { await this._fetchAndUpdateData(); }
                } catch (error) { console.error("Erro ao carregar dados iniciais:", error); this._updateStatus("Erro ao carregar", 'error'); await this._fetchAndUpdateData(); }
            }
            async _fetchSheetData() {
                this._updateStatus("Atualizando...", 'loading');
                const url = `https://docs.google.com/spreadsheets/d/${this.config.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(this.config.SHEET_NAME)}&t=${Date.now()}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    const csvText = await response.text(); const currentHash = this._hashString(csvText);
                    if (currentHash === this.state.lastUpdateHash) {
                        this.elements.autoUpdateStatus.textContent = `Base de dados verificada às ${new Date().toLocaleTimeString()}.`;
                        this._updateStatus(`Pronto`, 'success'); return { updated: false };
                    }
                    const parsedData = this._parseCSV(csvText);
                    if (parsedData.length < 2) { throw new Error("CSV inválido ou vazio."); }
                    const headers = parsedData[0].map(h => h.trim().toLowerCase());
                    const questionIndex = headers.indexOf("pergunta"); const answerIndex = headers.indexOf("resposta");
                    if (questionIndex === -1 || answerIndex === -1) { this._addBotMessage(`ERRO: Não encontrei as colunas "pergunta" e "resposta".`); throw new Error("Cabeçalhos não encontrados."); }
                    const formattedData = parsedData.slice(1).map(row => ({ question: row[questionIndex]?.trim() || "", answer: row[answerIndex]?.trim() || "", processedQuestion: this._processQuery(row[questionIndex]?.trim() || "") })).filter(item => item.question && item.answer);
                    return { data: formattedData, hash: currentHash, updated: true };
                } catch (error) { console.error("Erro ao buscar dados da planilha:", error); this._updateStatus("Erro ao atualizar", 'error'); throw error; }
            }
            async _fetchAndUpdateData(isManual = false) {
                try {
                    const result = await this._fetchSheetData();
                    if (result && result.updated) {
                        this.state.qaData = result.data; this.state.lastUpdateHash = result.hash;
                        await this._saveToDatabase(result.data, result.hash); this._initSearchEngine();
                        this._updateStatus(`Pronto`, 'success'); this.elements.autoUpdateStatus.textContent = `Base de dados atualizada às ${new Date().toLocaleTimeString()}`;
                        if (this.elements.chatArea.children.length > 1 || isManual) { this._addBotMessage(`Base de conhecimento atualizada! Agora tenho ${result.data.length} respostas.`); }
                    }
                } catch (error) { this._addBotMessage("Ocorreu um erro durante a atualização."); }
            }
            _startAutoUpdate() { if (this.state.autoUpdateIntervalId) clearInterval(this.state.autoUpdateIntervalId); this.state.autoUpdateIntervalId = setInterval(async () => { try { const { updated } = await this._fetchSheetData(); if (updated) { this._showUpdateBanner(); } } catch (error) { console.error("Erro na verificação automática:", error); this.elements.autoUpdateStatus.textContent = `Erro na verificação (${new Date().toLocaleTimeString()})`; } }, this.config.AUTO_UPDATE_INTERVAL); this.elements.autoUpdateStatus.textContent = `Verificação a cada ${this.config.AUTO_UPDATE_INTERVAL / 60000} min.`; }
            _initSearchEngine() { this.state.fuse = new Fuse(this.state.qaData, { keys: ['processedQuestion'], includeScore: true, threshold: 0.4, ignoreLocation: true, minMatchCharLength: 2 }); }
            
            _processQuery(text) {
                if (!text || typeof nlp === 'undefined') return text.toLowerCase().replace(/[^\w\s]/gi, '');
                let doc = nlp(text);
                doc.normalize('heavy');
                let terms = doc.nouns().out('array');
                terms = terms.concat(doc.verbs().out('array'));
                terms = terms.concat(doc.adjectives().out('array'));
                if (terms.length === 0) { return doc.text('reduced'); }
                return terms.join(' ');
            }

            async _handleQuestion() {
                const question = this.elements.questionInput.value.trim();
                const questionLower = question.toLowerCase();
                if (!question) return;
                
                if (this.state.isAwaitingSuggestion) {
                    this._addUserMessage(question); this._submitQuestionToForm(question, true); 
                    this.state.isAwaitingSuggestion = false; this.elements.questionInput.placeholder = "Digite sua mensagem...";
                    this.elements.questionInput.value = ''; return;
                }
                
                this._addUserMessage(question); this.elements.questionInput.value = '';
                if (question.startsWith('/')) { this._handleCommand(question); return; }
                
                this._showTypingIndicator();
                
                // --- NOVA LÓGICA PARA PERGUNTAS VAGAS ---
                const isVague = this.config.VAGUE_PHRASES.includes(questionLower);
                if (isVague) {
                    const suggestions = this.state.qaData.filter(item => 
                        item.question.toLowerCase().startsWith(questionLower)
                    ).map(item => ({ item })); // Formata para o formato que a função de botões espera

                    if (suggestions.length > 0) {
                        this._addBotMessage(`Isso é um pouco vago. Você quis dizer alguma destas opções?`, suggestions.slice(0, 4));
                    } else {
                        this._addBotMessage(`Sua pergunta é muito genérica. Por favor, tente ser mais específico (ex: "${question} o cartão?").`);
                    }
                    return;
                }

                setTimeout(async () => {
                    try {
                        let answerText = null; let answerOptions = [];
                        const processedQuery = this._processQuery(question);

                        if (processedQuery.split(' ').length < 2 && question.length < 5) {
                            answerText = "Sua pergunta é muito curta. Por favor, tente ser mais específico.";
                            this._addBotMessage(answerText, answerOptions); return;
                        }
                        
                        if (this.state.isAdvancedMode && this.state.isModelLoaded) {
                            const embeddingMatch = await this._findBestMatchWithEmbedding(question);
                            if (embeddingMatch) { answerText = embeddingMatch.item.answer; }
                        }
                        
                        if (!answerText) {
                            if (!this.state.fuse) { answerText = "A base de conhecimento não está pronta."; }
                            else {
                                const results = this.state.fuse.search(processedQuery);
                                if (results.length > 0 && results[0].score < this.config.FUSE_THRESHOLD) {
                                    answerText = results[0].item.answer;
                                } else if (results.length > 0) {
                                    answerText = "Não tenho certeza, mas talvez uma destas opções ajude:";
                                    answerOptions = results.slice(0, 3);
                                } else {
                                    this.state.lastUnansweredQuestion = question;
                                    answerText = "Desculpe, não encontrei uma resposta. Gostaria de adicionar esta pergunta à nossa base de conhecimento?";
                                }
                            }
                        }
                        this._addBotMessage(answerText, answerOptions); 
                        if (answerText.includes("Gostaria de adicionar esta pergunta")) { this._showAddQuestionButtons(); }
                    } catch (error) {
                        console.error("Erro ao processar pergunta:", error);
                        this._addBotMessage("Ocorreu um erro ao processar sua pergunta.");
                    }
                }, 800);
            }
            
            // O resto do código permanece o mesmo.
            _showAddQuestionButtons(){const messageDiv=this.elements.chatArea.querySelector('.message:last-child');if(!messageDiv)return;const buttonsContainer=document.createElement('div');buttonsContainer.className='action-buttons';const yesButton=document.createElement('button');yesButton.className='action-button yes';yesButton.textContent='Sim';yesButton.onclick=()=>{this._submitQuestionToForm(this.state.lastUnansweredQuestion);buttonsContainer.remove();};const noButton=document.createElement('button');noButton.className='action-button no';noButton.textContent='Não';noButton.onclick=()=>{this._addBotMessage("Entendido! Se precisar de algo mais, é só perguntar.");buttonsContainer.remove();};buttonsContainer.appendChild(yesButton);buttonsContainer.appendChild(noButton);messageDiv.appendChild(buttonsContainer);}
            async _submitQuestionToForm(question,fromCommand=false){if(!question)return;const formUrl='https://docs.google.com/forms/d/e/1FAIpQLSdK1OUPcBGtMRdWQz4JhyeQBuet-wXbEQ4CyAX07f6rHSvdyA/formResponse';const formData=new FormData();formData.append('entry.2126538361',question);try{await fetch(formUrl,{method:'POST',mode:'no-cors',body:formData});let confirmationMessage=fromCommand?"Obrigado! Sua sugestão foi enviada para análise.":"Obrigado por contribuir! Sua pergunta foi enviada para nossa equipe.";this._addBotMessage(confirmationMessage);}catch(error){console.error("Erro ao enviar pergunta:",error);this._addBotMessage("Houve um erro ao enviar sua pergunta.");}
            this.state.lastUnansweredQuestion=null;}
            async _findBestMatchWithEmbedding(question){if(!this.state.isModelLoaded||!this.state.useModel)return null;try{const embeddings=await this.state.useModel.embed([question,...this.state.qaData.map(item=>item.question)]);const questionEmbedding=embeddings.slice(0,1);const answerEmbeddings=embeddings.slice(1);const scores=await tf.matMul(questionEmbedding,answerEmbeddings,false,true).data();let bestScore=-1,bestIndex=-1;scores.forEach((score,i)=>{if(score>bestScore){bestScore=score;bestIndex=i;}});return bestScore>this.config.SIMILARITY_THRESHOLD?{item:this.state.qaData[bestIndex],score:bestScore}:null;}catch(error){console.error("Erro ao usar embeddings:",error);return null;}}
            _handleCommand(command){const cmd=command.toLowerCase().split(' ')[0];switch(cmd){case'/ajuda':this._addBotMessage("Comandos disponíveis:\n`/ajuda`\n`/limpar`\n`/atualizar`\n`/debug`\n`/add` ou `/sugerir`");break;case'/limpar':this.elements.chatArea.innerHTML='';this._addBotMessage("Chat limpo!");break;case'/atualizar':this._addBotMessage("Iniciando verificação manual...");this._fetchAndUpdateData(true);break;case'/add':case'/sugerir':this.state.isAwaitingSuggestion=true;this._addBotMessage("Qual pergunta você gostaria de adicionar?");this.elements.questionInput.placeholder="Digite aqui a pergunta para sugerir...";this.elements.questionInput.focus();break;case'/debug':const headers=this.state.qaData.length>0?Object.keys(this.state.qaData[0]):['Nenhum dado'];let debugMessage=`--- Status da Base de Dados ---\n`;debugMessage+=`Total de P&R: ${this.state.qaData.length}\n`;debugMessage+=`Cabeçalhos: ${headers.join(', ')}\n\n`;debugMessage+=`--- Amostra (3 primeiras) ---\n`;if(this.state.qaData.length>0){this.state.qaData.slice(0,3).forEach((item,index)=>{debugMessage+=`[${index+1}] P: ${item.question}\n    R: ${item.answer}\n\n`;});}else{debugMessage+='Nenhum dado para exibir.';}
            this._addBotMessage(debugMessage);break;default:this._addBotMessage(`Comando "${cmd}" não reconhecido. Digite /ajuda.`);}}
            _setupEventListeners(){this.elements.askButton.addEventListener('click',()=>this._handleQuestion());this.elements.questionInput.addEventListener('keypress',(e)=>{if(e.key==='Enter')this._handleQuestion();});this.elements.advancedModeToggle.addEventListener('change',(e)=>{this.state.isAdvancedMode=e.target.checked;this._saveToDatabase(this.state.isAdvancedMode,this.config.MODEL_KEY);if(this.state.isAdvancedMode&&!this.state.isModelLoaded){this._startModelLoading();}
            this._addBotMessage(`Modo Avançado ${this.state.isAdvancedMode?'ativado':'desativado'}.`);});this.elements.suggestButton.addEventListener('click',()=>{this.elements.customSuggestionModal.style.display='flex';});this.elements.cancelSuggestionBtn.addEventListener('click',()=>{this.elements.customSuggestionModal.style.display='none';});this.elements.customSuggestionModal.addEventListener('click',(e)=>{if(e.target===this.elements.customSuggestionModal){this.elements.customSuggestionModal.style.display='none';}});this.elements.submitSuggestionBtn.addEventListener('click',()=>{const question=this.elements.suggestionTextarea.value.trim();if(question){this._submitQuestionToForm(question,true);this.elements.suggestionTextarea.value='';this.elements.submitSuggestionBtn.textContent='Enviado!';setTimeout(()=>{this.elements.customSuggestionModal.style.display='none';this.elements.submitSuggestionBtn.textContent='Enviar sugestão';},2000);}});this.elements.refreshLink.onclick=(e)=>{e.preventDefault();this.elements.updateBanner.style.display='none';this._fetchAndUpdateData(true);};}
            _addUserMessage(text){this._addMessage(text,'user');this.state.conversationHistory.push({role:'user',content:text});if(this.state.conversationHistory.length>10){this.state.conversationHistory.splice(0,this.state.conversationHistory.length-10);}}
            _addBotMessage(text,options=[]){this._removeTypingIndicator();this._addMessage(text,'bot',options);this.state.conversationHistory.push({role:'assistant',content:text});}
            _addMessage(text,sender,options=[]){const messageDiv=document.createElement('div');messageDiv.className=`message ${sender}-message`;const formattedText=this._createHyperlinks(text);const contentDiv=document.createElement('div');contentDiv.innerHTML=formattedText.replace(/\n/g,'<br>');messageDiv.appendChild(contentDiv);if(options.length>0){options.forEach(result=>{const button=document.createElement('button');button.className='option-button';button.textContent=result.item.question;button.onclick=()=>{this._addUserMessage(result.item.question);this._showTypingIndicator();setTimeout(()=>{this._addBotMessage(result.item.answer);},400);};messageDiv.appendChild(button);});}
            const timeDiv=document.createElement('div');timeDiv.className='message-time';timeDiv.textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});messageDiv.appendChild(timeDiv);this.elements.chatArea.appendChild(messageDiv);this.elements.chatArea.scrollTop=this.elements.chatArea.scrollHeight;}
            _showTypingIndicator(){this._removeTypingIndicator();const typingDiv=document.createElement('div');typingDiv.className='typing-indicator';typingDiv.id='typingIndicator';typingDiv.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';this.elements.chatArea.appendChild(typingDiv);this.elements.chatArea.scrollTop=this.elements.chatArea.scrollHeight;}
            _removeTypingIndicator(){const indicator=document.getElementById('typingIndicator');if(indicator)indicator.remove();}
            _updateStatus(text,status){this.elements.statusText.textContent=text;this.elements.statusDot.className='status-dot';if(status!=='success')this.elements.statusDot.classList.add(status);}
            _showUpdateBanner(){this.elements.updateBanner.style.display='block';}
            async _checkAdvancedModeStatus(){const useAdvancedMode=await this._getFromDatabase(this.config.MODEL_KEY);if(useAdvancedMode){this.state.isAdvancedMode=true;this.elements.advancedModeToggle.checked=true;this._startModelLoading();}}
            async _startModelLoading(){if(this.state.isModelLoading||this.state.isModelLoaded)return;this.state.isModelLoading=true;this.elements.modelLoadingProgress.style.display='block';try{this.state.useModel=await this._loadUSEWithProgress();this.state.isModelLoaded=true;this.elements.modelStatusText.textContent="Modelo avançado carregado!";this.elements.modelProgressText.textContent="100%";this.elements.modelProgressBar.style.width="100%";setTimeout(()=>{this.elements.modelLoadingProgress.style.display='none';this._addBotMessage("✅ O Modo Avançado está ativo!");},2000);}catch(error){console.error("Erro ao carregar modelo USE:",error);this.elements.modelStatusText.textContent="Erro ao carregar modelo";this.elements.modelProgressBar.style.backgroundColor="var(--error)";this.state.isAdvancedMode=false;this.elements.advancedModeToggle.checked=false;this._saveToDatabase(false,this.config.MODEL_KEY);this._addBotMessage("❌ Falha ao carregar o Modo Avançado.");}finally{this.state.isModelLoading=false;}}
            _loadUSEWithProgress(){return new Promise((resolve,reject)=>{let progress=0;const interval=setInterval(()=>{progress=Math.min(progress+0.05,0.95);this.elements.modelProgressText.textContent=`${Math.round(progress*100)}%`;this.elements.modelProgressBar.style.width=`${progress*100}%`;},400);use.load().then(model=>{clearInterval(interval);resolve(model);}).catch(err=>{clearInterval(interval);reject(err);});});}
            async _loadFromDatabase(){const data=await this._getFromDatabase(this.config.DATA_KEY)||[];const hash=await this._getFromDatabase(this.config.LAST_UPDATE_KEY)||"";return{data,hash};}
            async _saveToDatabase(value,key){return new Promise((resolve,reject)=>{const tx=this.state.db.transaction(this.config.STORE_NAME,'readwrite');tx.objectStore(this.config.STORE_NAME).put(value,key);tx.oncomplete=resolve;tx.onerror=()=>reject(tx.error);});}
            async _getFromDatabase(key){return new Promise((resolve,reject)=>{const tx=this.state.db.transaction(this.config.STORE_NAME,'readonly');const request=tx.objectStore(this.config.STORE_NAME).get(key);request.onsuccess=()=>resolve(request.result);request.onerror=()=>reject(request.error);});}
            _hashString(str){let hash=0;for(let i=0;i<str.length;i++){const char=str.charCodeAt(i);hash=(hash<<5)-hash+char;hash|=0;}return hash.toString();}
            _parseCSV(csvText){const rows=[];let currentRow=[];let currentField='';let inQuotedField=false;csvText=csvText.replace(/\r\n/g,'\n').replace(/\r/g,'\n');for(let i=0;i<csvText.length;i++){const char=csvText[i];if(inQuotedField){if(char==='"'){if(i+1<csvText.length&&csvText[i+1]==='"'){currentField+='"';i++;}else{inQuotedField=false;}}else{currentField+=char;}}else{switch(char){case',':currentRow.push(currentField);currentField='';break;case'\n':currentRow.push(currentField);rows.push(currentRow);currentRow=[];currentField='';break;case'"':if(currentField===''){inQuotedField=true;}else{currentField+=char;}break;default:currentField+=char;}}}if(currentField||currentRow.length>0){currentRow.push(currentField);rows.push(currentRow);}if(rows.length>0&&rows[rows.length-1].length===1&&rows[rows.length-1][0]===''){rows.pop();}return rows;}
            _createHyperlinks(text){if(!text)return'';const urlRegex=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return text.replace(urlRegex,(url)=>{const link=url.startsWith('www.')?`https://`+url:url;return`<a href="${link}" target="_blank" rel="noopener noreferrer">${url}</a>`;});}
        }
        document.addEventListener('DOMContentLoaded', () => { window.neuroAssist = new NeuroAssist(); });
    </script>
  <!-- Início do Código do Botão Flutuante -->
<style>
#fab-button{position:fixed;right:20px; top:50%; transform:translateY(-50%);width:60px;height:60px;background-color:#2575fc;border-radius:50%;border:none;color:white;box-shadow:0 6px 20px rgba(0,0,0,.2);cursor:pointer;z-index:9998;display:flex;justify-content:center;align-items:center;transition:all .3s;text-decoration:none;}
#fab-button.active{z-index:10000;background-color:#e74c3c!important;transform:scale(1.1) rotate(360deg)!important}
#fab-button:hover{transform:scale(1.1)}
#fab-button svg{width:32px;height:32px;transition:opacity .3s,transform .3s}
.fab-icon-close{display:none}
#fab-button.active .fab-icon-open{opacity:0;transform:rotate(90deg);display:none}
#fab-button.active .fab-icon-close{opacity:1;transform:rotate(0);display:block}
#fab-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:9999;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .4s,visibility .4s}
#fab-modal.show{opacity:1;visibility:visible}
.fab-modal-content{background-color:#fff;width:95vw;height:95vh;max-width:1400px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;transform:scale(.8);transition:transform .4s cubic-bezier(.18,.89,.32,1.28)}
#fab-modal.show .fab-modal-content{transform:scale(1)}
.fab-modal-content iframe{width:100%;height:100%;border:none}
</style>
<button id="fab-button"><span class="fab-icon-open"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/></svg></span><span class="fab-icon-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></span></button>
<div id="fab-modal"><div class="fab-modal-content"><iframe src="https://franklinsiltol.github.io/dashdelink/" title="Conteúdo"></iframe></div></div>
<script>
(function(){
    const btn=document.getElementById('fab-button'),modal=document.getElementById('fab-modal');
    if(!btn||!modal)return;
    const closeAction=()=>{
        modal.classList.remove('show');
        btn.classList.remove('active');
        const content=modal.querySelector('.fab-modal-content');
        if(content) content.style.transform='scale(0.8)';
    };
    btn.addEventListener('click',()=>{
        const isActive=btn.classList.contains('active');
        if(isActive){
            closeAction();
        }else{
            modal.classList.add('show');
            btn.classList.add('active');
            const content=modal.querySelector('.fab-modal-content');
            if(content) content.style.transform='scale(1)';
        }
    });
    modal.addEventListener('click',e=>{if(e.target===modal)closeAction()});
})()
</script>
<!-- Fim do Código -->
  </body>
</html>
